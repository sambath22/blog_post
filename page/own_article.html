<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>own-article</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />

    <!-- Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
  </head>

  <body>
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header text-center">
        <img src="../assets/img/image.png" alt="Logo" />
        Blog Post
      </div>
      <ul class="menu-sidebar">
        <li>
          <a href="../index.html">
            <svg width="24" height="24" fill="none">
              <path
                d="M21 12C21 16.97 16.97 21 12 21C7.03 21 3 16.97 3 12M21 12C21 7.03 16.97 3 12 3M21 12H19M3 12C3 7.03 7.03 3 12 3M3 12H5M12 3V5M13.32 10.5C12.97 10.19 12.51 10 12 10C10.89 10 10 10.89 10 12C10 13.1 10.89 14 12 14C13.1 14 14 13.1 14 12C14 11.4 13.74 10.87 13.32 10.5ZM13.32 10.5L15.82 8"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
              ></path>
            </svg>
            Dashboard
          </a>
        </li>
        <li>
          <details open>
            <summary>
              <svg width="20" height="20" fill="none">
                <path
                  d="M7 25V2.005C7 2.005 7 1 8 1H30C30 1 31 1.005 31 2.005V28.005C31 28.005 31 31 28 31H4C4 31 1 31.005 1 27.005V12.005C1 12.005 1 11 2 11H4M13 7H18M13 11H25M13 15H25M13 19H25M13 23H25"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                ></path>
              </svg>
              My Articles
            </summary>
            <ul>
              <li>
                <a href="own_article.html" class="menu-active">All Articles</a>
              </li>
              <li><a href="create-article.html">Create Article</a></li>
            </ul>
          </details>
        </li>
        <li>
          <a href="categories.html">
            <svg width="20" height="20" fill="none">
              <path
                d="M5 10H7C9 10 10 9 10 7V5C10 3 9 2 7 2H5C3 2 2 3 2 5V7C2 9 3 10 5 10ZM17 10H19C21 10 22 9 22 7V5C22 3 21 2 19 2H17C15 2 14 3 14 5V7C14 9 15 10 17 10ZM17 22H19C21 22 22 21 22 19V17C22 15 21 14 19 14H17C15 14 14 15 14 17V19C14 21 15 22 17 22ZM5 22H7C9 22 10 21 10 19V17C10 15 9 14 7 14H5C3 14 2 15 2 17V19C2 21 3 22 5 22Z"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              ></path>
            </svg>
            Category
          </a>
        </li>
        <li>
          <a href="../page/profile.html">
            <svg width="20" height="20" fill="none">
              <path
                d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              ></path>
            </svg>
            Profile
          </a>
        </li>
      </ul>
    </aside>
    <!-- Main Content -->
    <div class="main-content">
      <!-- Topbar -->
      <div class="topbar">
        <div class="text-end">
          <div id="welcomeMessage" class="fw-semibold">Welcome...</div>
          <div id="email" class="text-muted small">email@example.com</div>
        </div>
        <img id="avatar" class="avatar" src="" />
      </div>

      <!-- Content -->
      <div class="container my-4">
        <h3 class="mb-3">My Articles</h3>
        <a href="./create-article.html" class="text-decoration-none"
          >+ Create New Article</a
        >

        <table class="table table-bordered mt-4">
          <thead class="bg-light">
            <tr>
              <th>Image</th>
              <th>Title</th>
              <th>Category</th>
              <th>Created At</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <script>
      const token = localStorage.getItem("token");

      if (!token) {
        alert("Please login first!");
        window.location.href = "../login.html";
      }

      // ================= LOAD PROFILE =================
      fetch("http://blogs.csm.linkpc.net/api/v1/auth/profile", {
        headers: { Authorization: "Bearer " + token },
      })
        .then((res) => res.json())
        .then((data) => {
          const p = data.data;
          document.getElementById(
            "welcomeMessage"
          ).textContent = `Welcome, ${p.firstName} ${p.lastName}!`;
          document.getElementById("email").textContent = p.email;
          document.getElementById("avatar").src =
            p.avatar || "https://via.placeholder.com/150";
        });

      // ================= LOAD ALL CATEGORIES =================
      let categoryMap = {};

      async function loadCategories() {
        const res = await fetch(
          "http://blogs.csm.linkpc.net/api/v1/categories"
        );
        const data = await res.json();

        data.data.items.forEach((cat) => {
          categoryMap[cat.id] = cat.name;
        });
      }

      // ================= LOAD OWN ARTICLES =================
      async function loadArticles() {
        await loadCategories(); // Load category list one time only

        const res = await fetch(
          "http://blogs.csm.linkpc.net/api/v1/articles/own",
          {
            headers: {
              Authorization: "Bearer " + token,
            },
          }
        );

        const result = await res.json();
        const list = result.data?.items || [];
        const tbody = document.getElementById("tbody");

        if (list.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No articles found.</td></tr>`;
          return;
        }

        let rows = "";
        list.forEach((article) => {
          const catName = categoryMap[article.categoryId] || "N/A";

          rows += `
          <tr>
            <td><img src="${
              article.thumbnail || "../assets/images/default.jpg"
            }" width="100" height="100" /></td>
            <td>${article.title}</td>
            <td>${catName}</td>
            <td>${new Date(article.createdAt).toLocaleDateString()}</td>
            <td>
              <a href="./edit-article.html?id=${
                article.id
              }" class="btn btn-sm"><i class="bi bi-pencil-square"></i></a>
              <button onclick="deleteArticle('${
                article.id
              }')" class="btn btn-sm"><i class="bi bi-trash3"></i></button>
            </td>
          </tr>
        `;
        });

        tbody.innerHTML = rows;
      }

      loadArticles();

      // ================= DELETE ARTICLE =================
      function deleteArticle(id) {
        if (!confirm("Are you sure you want to delete?")) return;

        fetch(`http://blogs.csm.linkpc.net/api/v1/articles/${id}`, {
          method: "DELETE",
          headers: { Authorization: "Bearer " + token },
        })
          .then((res) => res.json())
          .then(() => {
            alert("Deleted successfully!");
            loadArticles();
          });
      }
    </script>
  </body>
</html>
